<div class="map-wrapper">
    <div id="map-container"></div>
    <div class="map-overlays">
        {% include 'components/legend.html' %}
        {% include 'components/timeline.html' %}
    </div>
</div>

<script>
// Initialize map and popup globally
let map;
let popup;

// Initialize the map when the page loads
document.addEventListener('DOMContentLoaded', () => {
    // Get mapbox token
    const mapboxToken = '{{ mapbox_token }}';
    
    // Validate token
    if (!mapboxToken || mapboxToken === 'None') {
        console.error('Mapbox token not found');
        document.getElementById('map-container').innerHTML = `
            <div style="padding: 20px; color: red;">
                Error: Mapbox token not configured. Please check your environment variables.
            </div>`;
        return;
    }

    // Initialize mapboxgl map
    mapboxgl.accessToken = mapboxToken;
    
    try {
        map = new mapboxgl.Map({
            container: 'map-container',
            style: 'mapbox://styles/mapbox/satellite-v9',
            center: [15.2504, 25.3345],
            zoom: 3.0,
            pitch: 0,
            bearing: 0,
            projection: 'globe'
        });

        // Add atmosphere and stars
        map.on('style.load', () => {
            // Add atmosphere layer
            map.setFog({
                'color': 'rgb(186, 210, 235)',
                'high-color': 'rgb(36, 92, 223)',
                'horizon-blend': 0.02,
                'space-color': 'rgb(11, 11, 25)',
                'star-intensity': 0.6
            });
            
            // Optional: Add custom star layer
            map.addLayer({
                'id': 'sky',
                'type': 'sky',
                'paint': {
                    'sky-type': 'atmosphere',
                    'sky-atmosphere-sun': [0.0, 90.0],
                    'sky-atmosphere-sun-intensity': 15
                }
            });
        });

        // Initialize popup
        popup = new mapboxgl.Popup({
            closeButton: false,
            closeOnClick: false
        });

        // Wait for map to load before making it available globally
        map.on('load', () => {
            window.map = map;
            window.popup = popup;
            console.log('Map initialized successfully');
            
            // Remove the San Francisco test movement
            // map.easeTo({
            //     center: [-122.4194, 37.7749],
            //     zoom: 12,
            //     duration: 2000
            // });
        });

    } catch (error) {
        console.error('Error initializing map:', error);
        document.getElementById('map-container').innerHTML = `
            <div style="padding: 20px; color: red;">
                Error initializing map: ${error.message}
            </div>`;
    }
});

// Map update handler
window.handleMapUpdate = function(geojsonData) {
    try {
        console.log('Handling map update with data:', geojsonData);
        
        if (!map || !geojsonData?.features) {
            console.error('Map not initialized or invalid data');
            return;
        }

        // Ensure metrics are properly structured
        geojsonData.features.forEach(feature => {
            if (typeof feature.properties.metrics === 'string') {
                try {
                    feature.properties.metrics = JSON.parse(feature.properties.metrics);
                } catch (e) {
                    console.error('Error parsing metrics:', e);
                    feature.properties.metrics = {
                        land_degradation: 0,
                        soil_organic_carbon: 0,
                        vegetation_cover: 0,
                        biodiversity_index: 0
                    };
                }
            }
        });

        // Update or create the data source
        if (!map.getSource('h3-data')) {
            map.addSource('h3-data', {
                type: 'geojson',
                data: geojsonData
            });
        } else {
            map.getSource('h3-data').setData(geojsonData);
        }

        // Update the layer
        const layerId = 'h3-layer';
        if (map.getLayer(layerId)) {
            map.removeLayer(layerId);
        }

        // Get current selected metric
        const metricSelect = document.getElementById('metric-select');
        const currentMetric = metricSelect ? metricSelect.value : 'land_degradation';

        map.addLayer({
            'id': layerId,
            'type': 'fill',
            'source': 'h3-data',
            'paint': {
                'fill-color': [
                    'interpolate',
                    ['linear'],
                    ['get', currentMetric, ['get', 'metrics']],
                    0, getMetricColorScale(currentMetric)[0],
                    getMetricMaxValue(currentMetric), getMetricColorScale(currentMetric)[1]
                ],
                'fill-opacity': 0.7,
                'fill-outline-color': '#ffffff'
            }
        });

        // Calculate bounds and animate map
        const bounds = new mapboxgl.LngLatBounds();
        geojsonData.features.forEach(feature => {
            if (feature.geometry.type === 'Polygon') {
                feature.geometry.coordinates[0].forEach(coord => {
                    bounds.extend(coord);
                });
            }
        });

        if (!bounds.isEmpty()) {
            map.fitBounds(bounds, {
                padding: 50,
                duration: 1600,
                maxZoom: 10,
                essential: true
            });
        }

        // Update metric display
        if (typeof updateMetricInfo === 'function') {
            updateMetricInfo(currentMetric);
        }

        return true;
    } catch (error) {
        console.error('Error updating map:', error);
        throw error;
    }
};

// Add a test function to the window object
window.testMapMovement = function() {
    console.log('Testing map movement...');
    if (map) {
        map.setCenter([-122.4194, 37.7749]);
        map.setZoom(12);
        console.log('Map movement command sent');
    } else {
        console.error('Map not initialized');
    }
};

// Rest of your existing code...
</script>

<style>
.map-wrapper {
    position: relative;
    height: 100%;
    width: 100%;
}

#map-container {
    position: absolute;
    top: 0;
    bottom: 0;
    left: 0;
    right: 0;
    width: 100%;
    height: 100%;
}

.map-overlays {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    pointer-events: none; /* Allow clicks to pass through to map */
    z-index: 1;
}

/* Make specific overlay elements interactive */
.map-overlays .legend,
.map-overlays .timeline {
    pointer-events: auto; /* Re-enable interactions for specific elements */
}

.popup-content {
    padding: 10px;
    max-width: 200px;
}

.popup-content h4 {
    margin: 0 0 8px 0;
    color: #333;
}

.popup-content p {
    margin: 4px 0;
    color: #666;
}
</style> 