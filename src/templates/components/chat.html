<div id="chat-container">
    <div id="chat-messages">
        <div class="message agent-message">
            Hello! I'm your environmental data assistant. How can I help you today?
        </div>
    </div>
    <div id="chat-input-container">
        <textarea 
            id="chat-input" 
            placeholder="Type your message here..." 
            rows="3"
        ></textarea>
        <button id="send-button" onclick="sendMessage()">Send</button>
    </div>
</div>

<script>
async function sendMessage() {
    const input = document.getElementById('chat-input');
    const messagesDiv = document.getElementById('chat-messages');
    const message = input.value.trim();
    
    if (!message) return;

    // Add user message to chat
    messagesDiv.innerHTML += `
        <div class="message user-message">
            ${escapeHtml(message)}
        </div>
    `;

    // Clear input
    input.value = '';

    // Add loading message
    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'message agent-message loading';
    loadingDiv.textContent = 'Thinking...';
    messagesDiv.appendChild(loadingDiv);

    try {
        // Use window.location.origin to get the current server URL
        const serverUrl = window.location.origin;
        const response = await fetch(`${serverUrl}/chat`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                type: 'UserQuery',
                question: message
            })
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        
        // Remove loading message
        messagesDiv.removeChild(loadingDiv);

        // Format and display response
        let responseHtml = '<div class="message agent-message">';
        if (data.insights && data.insights.length > 0) {
            responseHtml += '<strong>Insights:</strong><br>';
            responseHtml += data.insights.map(insight => `• ${escapeHtml(insight)}`).join('<br>');
        }
        if (data.recommendations && data.recommendations.length > 0) {
            responseHtml += '<br><br><strong>Recommendations:</strong><br>';
            responseHtml += data.recommendations.map(rec => `• ${escapeHtml(rec)}`).join('<br>');
        }
        responseHtml += '</div>';
        
        messagesDiv.innerHTML += responseHtml;
    } catch (error) {
        // Remove loading message
        messagesDiv.removeChild(loadingDiv);
        
        // Show more specific error message
        let errorMessage = 'Sorry, I encountered an error. ';
        if (error.message.includes('Failed to fetch')) {
            errorMessage += 'Cannot connect to the server. Please make sure the server is running.';
        } else {
            errorMessage += 'Please try again.';
        }
        
        messagesDiv.innerHTML += `
            <div class="message agent-message error">
                ${errorMessage}
            </div>
        `;
        console.error('Chat error:', error);
    }

    // Scroll to bottom
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

// Utility function to escape HTML and prevent XSS
function escapeHtml(unsafe) {
    return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

// Add enter key support
document.getElementById('chat-input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});
</script>

<style>
#chat-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
    height: 600px;
    display: flex;
    flex-direction: column;
}

#chat-messages {
    flex-grow: 1;
    overflow-y: auto;
    margin-bottom: 20px;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 5px;
}

.message {
    margin: 10px 0;
    padding: 10px;
    border-radius: 5px;
    max-width: 80%;
}

.user-message {
    background-color: #e3f2fd;
    margin-left: auto;
}

.agent-message {
    background-color: #f5f5f5;
    margin-right: auto;
}

.error {
    background-color: #ffebee;
    color: #c62828;
}

.loading {
    font-style: italic;
    color: #666;
}

#chat-input-container {
    display: flex;
    gap: 10px;
}

#chat-input {
    flex-grow: 1;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 5px;
    resize: none;
}

#send-button {
    padding: 10px 20px;
    background-color: #2196f3;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}

#send-button:hover {
    background-color: #1976d2;
}
</style> 