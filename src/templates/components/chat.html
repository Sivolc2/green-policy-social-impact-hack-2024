<div class="chat-container">
    <div class="chat-mode-toggle">
        <button class="toggle-button active" data-mode="data">Data</button>
        <button class="toggle-button" data-mode="analysis">Analysis</button>
    </div>
    
    <div id="chat-messages" class="chat-messages">
        <!-- Messages will be inserted here -->
    </div>
    
    <div class="chat-input-container">
        <input type="text" id="chat-input" class="chat-input" placeholder="Ask about environmental data...">
        <div class="button-group">
            <button onclick="sendMessage()" class="chat-send-button">Send</button>
            <button onclick="sendToMap()" class="map-send-button">Send To Map</button>
        </div>
    </div>
</div>

<script>
let messageQueue = [];
let isProcessing = false;
let currentMode = 'data';

function addMessageToChat(role, message, summaryTable = '') {
    const messagesContainer = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message ${role}-message`;
    
    if (summaryTable || message.includes('<')) {
        messageDiv.innerHTML = `
            <div class="message-text">${message}</div>
            ${summaryTable ? `
                <div class="summary-section">
                    <h4 style="color: #ffffff; margin-bottom: 0.5rem;">Summary Table</h4>
                    ${summaryTable}
                </div>
            ` : ''}
        `;
    } else {
        const textDiv = document.createElement('div');
        textDiv.className = 'message-text';
        textDiv.textContent = message;
        messageDiv.appendChild(textDiv);
    }
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function getInitialPrompt() {
    const welcomeMessage = `Hello! I'm an expert environmental data analyst assistant. 

To get started, please ask me a hypothesis or research question about environmental changes, such as:

"I want to investigate land degradation trends in agricultural areas."

I'll do my best to provide relevant data insights and suggest additional data sources that could be useful.

Let me know how I can help!`;
    
    addMessageToChat('assistant', welcomeMessage);
}

function handleUserMessage(message) {
    // Add the user message to the chat
    addMessageToChat('user', message);
    
    // Process the hypothesis
    processHypothesis(message);
}

async function sendMessage() {
    const input = document.getElementById('chat-input');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Add user message
    addMessageToChat('user', message);
    
    // Show loading indicator
    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'chat-message loading-message';
    loadingDiv.innerHTML = '<div class="loading-dots"><span>.</span><span>.</span><span>.</span></div>';
    document.getElementById('chat-messages').appendChild(loadingDiv);
    
    try {
        const endpoint = '/chat';  // Use single endpoint
        
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                question: message,
                mode: currentMode  // Send current mode to backend
            })
        });
        
        const data = await response.json();
        console.log('Response from server:', data);
        
        // Remove loading indicator
        loadingDiv.remove();
        
        // Add AI response with summary table only if in data mode and table exists
        if (currentMode === 'data' && data.summary_table) {
            console.log('Summary table found:', data.summary_table);
            addMessageToChat('assistant', data.response, data.summary_table);
        } else {
            // In analysis mode or no summary table, just show response
            addMessageToChat('assistant', data.response);
        }
        
    } catch (error) {
        console.error('Error:', error);
        loadingDiv.remove();
        addMessageToChat('error', 'Sorry, there was an error processing your request.');
    }
    
    // Clear input
    input.value = '';
}

// Add this event listener to handle Enter key press
document.getElementById('chat-input').addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});

async function processHypothesis(hypothesis) {
    try {
        const response = await fetch('/api/process_hypothesis', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ hypothesis: hypothesis })
        });
        
        const result = await response.json();
        
        // Create a response message showing available and unavailable data
        let messageHTML = '<div class="dataset-results">';
        
        if (result.relevant_datasets.length > 0) {
            messageHTML += '<h4>Available Relevant Datasets:</h4><ul>';
            result.relevant_datasets.forEach(dataset => {
                messageHTML += `
                    <li>
                        <strong>${dataset.name}</strong>
                        <p>${dataset.description}</p>
                        <p class="dataset-meta">Time range: ${dataset.temporal_range}</p>
                    </li>`;
            });
            messageHTML += '</ul>';
        }
        
        if (result.unavailable_data.length > 0) {
            messageHTML += '<h4>Currently Unavailable Data:</h4><ul>';
            result.unavailable_data.forEach(item => {
                messageHTML += `
                    <li>
                        <strong>${item.type}</strong>
                        <p>${item.reason}</p>
                    </li>`;
            });
            messageHTML += '</ul>';
        }
        
        messageHTML += '</div>';
        
        // Add the response to the chat
        addMessageToChat('system', messageHTML);
        
    } catch (error) {
        console.error('Error processing hypothesis:', error);
        addMessageToChat('system', 'Sorry, there was an error processing your hypothesis.');
    }
}

// Call the getInitialPrompt function when the page loads
window.addEventListener('DOMContentLoaded', () => {
    getInitialPrompt();
    initializeToggleButtons();
});

function initializeToggleButtons() {
    const toggleButtons = document.querySelectorAll('.toggle-button');
    
    toggleButtons.forEach(button => {
        button.addEventListener('click', () => {
            toggleButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            currentMode = button.dataset.mode;
            
            // Update placeholder text based on mode
            const chatInput = document.getElementById('chat-input');
            if (currentMode === 'data') {
                chatInput.placeholder = 'Ask about environmental data...';
            } else {
                chatInput.placeholder = 'Ask for analysis of the selected region...';
                // Clear any existing messages when switching to analysis mode
                document.getElementById('chat-messages').innerHTML = '';
                addMessageToChat('assistant', 'Switched to analysis mode. How can I help analyze the selected region?');
            }
        });
    });
}

async function sendToMap() {
    try {
        // Get all chat messages
        const chatMessages = document.getElementById('chat-messages');
        const messages = Array.from(chatMessages.children).map(msg => ({
            role: msg.classList.contains('user-message') ? 'user' : 
                  msg.classList.contains('assistant-message') ? 'assistant' : 'system',
            content: msg.textContent
        }));
        
        // Show loading indicator
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'chat-message loading-message';
        loadingDiv.innerHTML = '<div class="loading-dots"><span>.</span><span>.</span><span>.</span></div>';
        chatMessages.appendChild(loadingDiv);
        
        // Also include current input if it exists
        const currentInput = document.getElementById('chat-input').value.trim();
        if (currentInput) {
            messages.push({
                role: 'user',
                content: currentInput
            });
        }
        
        const response = await fetch('/send-to-map', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                messages: messages
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('Response from server:', data);
        
        // Remove loading indicator
        loadingDiv.remove();
        
        // Clear input if there was any
        document.getElementById('chat-input').value = '';
        
        // Switch to analysis mode
        const analysisButton = document.querySelector('[data-mode="analysis"]');
        const toggleButtons = document.querySelectorAll('.toggle-button');
        toggleButtons.forEach(btn => btn.classList.remove('active'));
        analysisButton.classList.add('active');
        
        // Add feedback message
        addMessageToChat('system', 'Query sent to map visualization. Switching to analysis mode...');
        
    } catch (error) {
        console.error('Error sending to map:', error);
        addMessageToChat('error', 'Sorry, there was an error processing the conversation for map visualization. ' + error.message);
    }
}
</script>