<div class="chat-container">
    <div id="chat-messages" class="chat-messages">
        <!-- Messages will be inserted here -->
    </div>
    
    <div class="chat-input-container">
        <input type="text" id="chat-input" class="chat-input" placeholder="Ask about environmental data...">
        <button onclick="sendMessage()" class="chat-send-button">Send</button>
    </div>
</div>

<script>
let messageQueue = [];
let isProcessing = false;

function addMessageToChat(role, message) {
    const messagesContainer = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message ${role}-message`;
    messageDiv.textContent = message;
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function getInitialPrompt() {
    const welcomeMessage = `Hello! I'm an expert environmental data analyst assistant. 

To get started, please ask me a hypothesis or research question about environmental changes, such as:

"I want to investigate land degradation trends in agricultural areas."

I'll do my best to provide relevant data insights and suggest additional data sources that could be useful.

Let me know how I can help!`;
    
    addMessageToChat('assistant', welcomeMessage);
}

function handleUserMessage(message) {
    // Add the user message to the chat
    addMessageToChat('user', message);
    
    // Process the hypothesis
    processHypothesis(message);
}

async function sendMessage() {
    const input = document.getElementById('chat-input');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Add user message
    addMessageToChat('user', message);
    
    // Show loading indicator
    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'chat-message loading-message';
    loadingDiv.innerHTML = '<div class="loading-dots"><span>.</span><span>.</span><span>.</span></div>';
    document.getElementById('chat-messages').appendChild(loadingDiv);
    
    try {
        const response = await fetch('/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                question: message
            })
        });
        
        const data = await response.json();
        
        // Remove loading indicator
        loadingDiv.remove();
        
        // Add AI response
        addMessageToChat('assistant', data.response);
        
    } catch (error) {
        console.error('Error:', error);
        loadingDiv.remove();
        addMessageToChat('error', 'Sorry, there was an error processing your request.');
    }
    
    // Clear input
    input.value = '';
}

// Add this event listener to handle Enter key press
document.getElementById('chat-input').addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});

async function processHypothesis(hypothesis) {
    try {
        const response = await fetch('/api/process_hypothesis', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ hypothesis: hypothesis })
        });
        
        const result = await response.json();
        
        // Create a response message showing available and unavailable data
        let messageHTML = '<div class="dataset-results">';
        
        if (result.relevant_datasets.length > 0) {
            messageHTML += '<h4>Available Relevant Datasets:</h4><ul>';
            result.relevant_datasets.forEach(dataset => {
                messageHTML += `
                    <li>
                        <strong>${dataset.name}</strong>
                        <p>${dataset.description}</p>
                        <p class="dataset-meta">Time range: ${dataset.temporal_range}</p>
                    </li>`;
            });
            messageHTML += '</ul>';
        }
        
        if (result.unavailable_data.length > 0) {
            messageHTML += '<h4>Currently Unavailable Data:</h4><ul>';
            result.unavailable_data.forEach(item => {
                messageHTML += `
                    <li>
                        <strong>${item.type}</strong>
                        <p>${item.reason}</p>
                    </li>`;
            });
            messageHTML += '</ul>';
        }
        
        messageHTML += '</div>';
        
        // Add the response to the chat
        addMessageToChat('system', messageHTML);
        
    } catch (error) {
        console.error('Error processing hypothesis:', error);
        addMessageToChat('system', 'Sorry, there was an error processing your hypothesis.');
    }
}

// Call the getInitialPrompt function when the page loads
window.addEventListener('DOMContentLoaded', getInitialPrompt);
</script>

<style>
.chat-container {
    display: flex;
    flex-direction: column;
    height: 100%;
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
    background-color: #2d2d2d;
}

.chat-messages {
    flex-grow: 1;
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    background-color: #2d2d2d;
}

.chat-message {
    padding: 12px 16px;
    border-radius: 12px;
    max-width: 80%;
    word-wrap: break-word;
    line-height: 1.4;
}

.user-message {
    align-self: flex-end;
    background-color: #007bff;
    color: white;
}

.assistant-message {
    align-self: flex-start;
    background-color: #383838;
    color: #ffffff;
    border: 1px solid #505050;
    white-space: pre-line;
}

.error-message {
    align-self: flex-start;
    background-color: #dc3545;
    color: white;
}

.loading-message {
    align-self: flex-start;
    background-color: #383838;
    border: 1px solid #505050;
    color: #ffffff;
}

.loading-dots span {
    animation: dots 1.5s infinite;
    display: inline-block;
}

.loading-dots span:nth-child(2) { animation-delay: 0.5s; }
.loading-dots span:nth-child(3) { animation-delay: 1s; }

@keyframes dots {
    0%, 20% { transform: translateY(0); }
    50% { transform: translateY(-5px); }
    80%, 100% { transform: translateY(0); }
}

.chat-input-container {
    display: flex;
    gap: 10px;
    padding: 20px 0;
    background-color: #2d2d2d;
}

.chat-input {
    flex-grow: 1;
    padding: 10px;
    border: 1px solid #505050;
    border-radius: 5px;
    font-size: 16px;
    background-color: #383838;
    color: #ffffff;
}

.chat-input::placeholder {
    color: #aaa;
}

.chat-send-button {
    padding: 10px 20px;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}

.chat-send-button:hover {
    background-color: #0056b3;
}

.message-insights {
    margin-bottom: 10px;
}

.message-recommendations {
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px solid #dee2e6;
}

.message-recommendations h4 {
    margin: 0 0 5px 0;
    font-size: 14px;
    color: #6c757d;
}

.message-recommendations p {
    margin: 5px 0;
    font-size: 14px;
}
</style> 