<div class="chat-container">
    <div id="chat-messages" class="chat-messages">
        <!-- Messages will be inserted here -->
    </div>
    
    <div class="chat-input-container">
        <input type="text" id="chat-input" class="chat-input" placeholder="Ask about environmental data...">
        <button onclick="sendMessage()" class="chat-send-button">Send</button>
    </div>
</div>

<script>
let messageQueue = [];
let isProcessing = false;

async function sendMessage() {
    const input = document.getElementById('chat-input');
    const messagesContainer = document.getElementById('chat-messages');
    
    if (!input.value.trim()) return;
    
    // Create temporary message elements
    const userMessageDiv = createMessageElement(input.value, 'user');
    const loadingDiv = createLoadingElement();
    
    // Add messages to container
    messagesContainer.appendChild(userMessageDiv);
    messagesContainer.appendChild(loadingDiv);
    
    // Scroll to bottom
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    try {
        const response = await fetch('/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                question: input.value
            })
        });
        
        const data = await response.json();
        
        // Remove loading indicator
        if (loadingDiv && loadingDiv.parentNode) {
            loadingDiv.parentNode.removeChild(loadingDiv);
        }
        
        // Create and add assistant response
        const assistantMessageDiv = createAssistantResponse(data);
        messagesContainer.appendChild(assistantMessageDiv);
        
        // Scroll to new message
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
    } catch (error) {
        console.error('Error:', error);
        // Remove loading indicator
        if (loadingDiv && loadingDiv.parentNode) {
            loadingDiv.parentNode.removeChild(loadingDiv);
        }
        
        // Show error message
        const errorDiv = createErrorMessage();
        messagesContainer.appendChild(errorDiv);
    }
    
    // Clear input
    input.value = '';
}

function createMessageElement(text, role) {
    const div = document.createElement('div');
    div.className = `chat-message ${role}-message`;
    div.textContent = text;
    return div;
}

function createLoadingElement() {
    const div = document.createElement('div');
    div.className = 'chat-message loading-message';
    div.innerHTML = '<div class="loading-dots"><span>.</span><span>.</span><span>.</span></div>';
    return div;
}

function createAssistantResponse(data) {
    const div = document.createElement('div');
    div.className = 'chat-message assistant-message';
    
    // Add insights
    const insights = document.createElement('div');
    insights.className = 'message-insights';
    data.insights.forEach(insight => {
        const p = document.createElement('p');
        p.textContent = insight;
        insights.appendChild(p);
    });
    div.appendChild(insights);
    
    // Add recommendations if they exist
    if (data.recommendations && data.recommendations.length) {
        const recommendations = document.createElement('div');
        recommendations.className = 'message-recommendations';
        const header = document.createElement('h4');
        header.textContent = 'Additional Information:';
        recommendations.appendChild(header);
        
        data.recommendations.forEach(rec => {
            if (rec && rec !== 'No source available' && rec !== 'No additional information') {
                const p = document.createElement('p');
                p.textContent = rec;
                recommendations.appendChild(p);
            }
        });
        
        if (recommendations.children.length > 1) { // Only add if there are actual recommendations
            div.appendChild(recommendations);
        }
    }
    
    return div;
}

function createErrorMessage() {
    const div = document.createElement('div');
    div.className = 'chat-message error-message';
    div.textContent = 'Sorry, there was an error processing your request. Please try again.';
    return div;
}

// Add event listener for Enter key
document.getElementById('chat-input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        sendMessage();
    }
});
</script>

<style>
.chat-container {
    display: flex;
    flex-direction: column;
    height: 100%;
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
}

.chat-messages {
    flex-grow: 1;
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.chat-message {
    padding: 10px 15px;
    border-radius: 10px;
    max-width: 80%;
    word-wrap: break-word;
}

.user-message {
    align-self: flex-end;
    background-color: #007bff;
    color: white;
}

.assistant-message {
    align-self: flex-start;
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
}

.error-message {
    align-self: flex-start;
    background-color: #dc3545;
    color: white;
}

.loading-message {
    align-self: flex-start;
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
}

.loading-dots span {
    animation: dots 1.5s infinite;
    display: inline-block;
}

.loading-dots span:nth-child(2) { animation-delay: 0.5s; }
.loading-dots span:nth-child(3) { animation-delay: 1s; }

@keyframes dots {
    0%, 20% { transform: translateY(0); }
    50% { transform: translateY(-5px); }
    80%, 100% { transform: translateY(0); }
}

.chat-input-container {
    display: flex;
    gap: 10px;
    padding: 20px 0;
}

.chat-input {
    flex-grow: 1;
    padding: 10px;
    border: 1px solid #dee2e6;
    border-radius: 5px;
    font-size: 16px;
}

.chat-send-button {
    padding: 10px 20px;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}

.chat-send-button:hover {
    background-color: #0056b3;
}

.message-insights {
    margin-bottom: 10px;
}

.message-recommendations {
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px solid #dee2e6;
}

.message-recommendations h4 {
    margin: 0 0 5px 0;
    font-size: 14px;
    color: #6c757d;
}

.message-recommendations p {
    margin: 5px 0;
    font-size: 14px;
}
</style> 